/*#BY JESUS EDUARDO MURRIETA ROSAS
#Reposiotrio en github del proyecto 
#github     https://github.com/soru13/GestionDeProyectos*/
;// Generated by CoffeeScript 1.4.0
var ajax=(function($){
	var nombre,pswd,ip;
	var arrayNames = {};
	var websocket;
	var _accion="";
  	function started(){
  		$('#chat').animate({scrollTop: $("#chatInsite").height()}, 800);
  		
  		//$("#emoticon").html('<a href="#" title=":)" class="emoticon"/><a href="#" title=":8" class="emoticon"/><a href="#" title=":D" class="emoticon"/><a href="#" title=":(" class="emoticon"/><a href="#" title=":O" class="emoticon"/><a href="#" title=":P" class="emoticon"/><a href="#" title=":cool:" class="emoticon"/><a href="#" title=":\'(" class="emoticon"/><a href="#" title=":|" class="emoticon"/>');
  		_accion = $('#formulario').find('input[type=submit]').val();
  		var id=$("#id").text();
  		var User =$("#User").text();
		var UserLoginId =$("#UserLoginId").text();
		var UserLogin=$("#userlogin").text();
		var perfilid=$("#perfilid").text();
	    nombre=$('article:last').find('span').text();
	    var urlimg=$(".picture figure img").attr("src");
		var img='<figure class="usuarioIMG" ><img src="'+urlimg+'" /><figcaption></figcaption></figure><span>';
		console.log("perfilUsuarioID "+perfilid+" Quien Recivio "+User+" usuarioLoginID "+UserLoginId);
	    $("#allformulario").show();
	    
  		if (_accion=="Responder") {
		    _mensaje();
		    if (nombre==UserLogin) {
		    	return false;
		    }else{
				$.ajax({
			          async:true,
			              url: '/leidos/',
			              type: 'POST',
			              data:"&idActividad="+id,
			              success: function(response) {
			                if (response.exito) {
			                  $("#leido").html('<img src="/static/base/img/inbox-5-24.ico"/>0 Notificaciones');
			                  console.log("exito");
			                }
			              },
			    });
		    }
  		};
		if (_accion=="AgregarMensaje") {
			_mensaje();
		}
		if (_accion=="Enviar Mensaje") {
			$('#formulario').bind('submit', function(e) {
			            e.preventDefault();
			            var url ='/MensajeAjax/';
			            var message = $("#id_Mensaje").val();
			            console.log("this mensaje"+message);
			            var token =$("input[type=hidden]").val();
			            var text = message;
				        // attacks
				        text = text.replace(/&(?!\s)|</g, function (s) { if(s == '&') return '&amp;'; else return '&lt;'; });
				        // links
				        //text = text.replace(/https?:\/\/(\S+)/, '');
				        // emoticons
				        text = text.replace(/(:\)|:8|:D|:hat|:rare|:silent|:lol|:shame|:xD|:imp|:secret|:a|:XD:|:sor:|:\(|:O|:P|:cool:|:'\(|:\|)/g, '<span title="$1" class="emoticon"></span>');
				        message = text;
			            var fd = new FormData($('#formulario').get(0));
			            fd.append("Mensaje", message );
			            fd.append("Envio", UserLoginId );
      					fd.append("Recivio", User );
      					fd.append("avatar", perfilid );
      					fd.append("Estatus", 'False' );
			            $.ajax({
			                url: url,
			                data: fd,
			                type: 'POST',
			               beforeSend: function(){
			                     console.log("fd"+fd);
			                     console.log("otro"+'&csrfmiddlewaretoken='+token+'&Mensaje='+message+'&Envio='+UserLoginId+'&Recivio='+User+'&avatar='+perfilid+'&Estatus=False');
			                },
			                success: function(data) {
			                  if (data.exito) {
			                  	//Formulario para enviar un nuevo mensaje
			                      $("#id_Mensaje").val('');
			                      $("#id_Mensaje").focus();
			                      console.log("se lo paso a la function "+message);
								 	ajaxStarted.enviarMensaje(message,img);
			                      $('#chatInsite').append($('<p>').append($('<article>').html('<figure class="usuarioIMG" ><img src="'+urlimg+'" /><figcaption></figcaption></figure><span>  '+ UserLogin + "  :</span> " + data.date)));			                      
			                      $('#chat').animate({scrollTop: $("#chatInsite").height()}, 800);
			                  } else {
			                    $("#serult").html('');
			                    $(".alert").show();
			                    if (data.errores.Descripcion) {
			                      $("#serult").html('No se ha insertado nada en el campo Error: '+data.errores.Descripcion);
			                    }
			                  }
			                },
			                processData: false,
			                contentType: false
			            });
			    });
		}
		function _mensaje(){
		    $('#formulario').bind('submit', function(e) {
			            e.preventDefault();
			            var url ='/Correo/';
			            var message = $("#id_Mensaje").val();
			            var token =$("input[type=hidden]").val();
			            var text = message;
				        // attacks
				        text = text.replace(/&(?!\s)|</g, function (s) { if(s == '&') return '&amp;'; else return '&lt;'; });
				        // links
				        //text = text.replace(/https?:\/\/(\S+)/, '');
				        // emoticons
				        text = text.replace(/(:\)|:8|:D|:\(|:O|:P|:cool:|:'\(|:\|)/g, '<span title="$1" class="emoticon"></span>');
				        message = text;
			            var fd = new FormData($('#formulario').get(0));
			            fd.append("Envio", UserLoginId );
            			fd.append("Actividad", id );
            			fd.append("Recivio", User );
            			fd.append("avatar", perfilid );
            			fd.append("Estatus", 'False' );
			            $.ajax({
			                url: url,
			                data:fd,
			                type: 'POST',
			               beforeSend: function(){
			                     console.log(fd);
			                },
			                success: function(data) {
			                  if (data.exito) {
			                      $("#formulario").get(0).reset();
			                      $('#chatInsite').append($('<p>').append($('<article>').html('<figure class="usuarioIMG" ><img src="'+urlimg+'" /><figcaption></figcaption></figure><span>'+ UserLogin + "  :</span> " + data.date)));			                      
			                      $('#chat').animate({scrollTop: $("#chatInsite").height()}, 800);
			                  } else {
			                    $("#serult").html('');
			                    $(".alert").show();
			                    if (data.errores.Descripcion) {
			                      $("#serult").html('No se ha insertado nada en el campo Error: '+data.errores.Descripcion);
			                    }
			                  }
			                },
			                processData: false,
			                contentType: false
			            });
			    });
		}
	}

  return{
    inicio:started
  }

})(jQuery);

$(document).on('ready', ajax.inicio );
